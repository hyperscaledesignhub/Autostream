apiVersion: v1
kind: ConfigMap
metadata:
  name: flink-config
  namespace: fluss
data:
  flink-conf.yaml: |
    # Flink Configuration with Prometheus Metrics Reporter
    # ======================================================
    
    # JobManager Configuration
    jobmanager.rpc.address: flink-jobmanager
    jobmanager.rpc.port: 6123
    jobmanager.memory.process.size: 1600m
    
    # TaskManager Configuration
    taskmanager.memory.process.size: 24g
    taskmanager.memory.task.off-heap.size: 4g
    taskmanager.memory.framework.off-heap.size: 2g
    taskmanager.numberOfTaskSlots: 32
    parallelism.default: 192
    
    # Blob and Query Server Ports
    blob.server.port: 6124
    queryable-state.server.ports: 6125
    
    # Metrics Configuration
    # =====================
    
    # Enable metrics reporters
    metrics.reporters: prometheus
    
    # Prometheus Reporter Configuration (Flink 1.20.3 uses factory.class)
    metrics.reporter.prometheus.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
    metrics.reporter.prometheus.port: 9249-9259
    metrics.reporter.prometheus.filterLabelValueCharacters: false
    
    # System Resource Metrics
    metrics.system-resource: true
    metrics.system-resource-probing-interval: 5000
    
    # Latency Tracking
    metrics.latency.interval: 10000
    metrics.latency.granularity: operator
    metrics.latency.history-size: 128
    
    # Web Frontend Configuration
    web.submit.enable: true
    web.cancel.enable: true
    web.tmpdir: /tmp/flink-web
    
    # Watermark configuration to prevent watermark stalling
    # This helps with low watermark issues when some partitions are idle
    pipeline.auto-watermark-interval: 200ms
    
    # Checkpointing Configuration - Using S3 with IRSA
    # NOTE: Bucket name will be replaced by submit-job-from-image.sh script
    # Format: s3://<cluster-name>-flink-state-<account-id>/flink-checkpoints/<cluster-name>/
    state.backend: rocksdb
    state.backend.incremental: true
    state.checkpoints.dir: s3://fluss-eks-cluster-flink-state-PLACEHOLDER/flink-checkpoints/fluss-eks-cluster/
    state.savepoints.dir: s3://fluss-eks-cluster-flink-state-PLACEHOLDER/flink-savepoints/fluss-eks-cluster/
    execution.checkpointing.interval: 300000  # 5 minutes (300 seconds)
    execution.checkpointing.mode: AT_LEAST_ONCE
    execution.checkpointing.timeout: 600000  # 10 minutes
    execution.checkpointing.max-concurrent-checkpoints: 1
    execution.checkpointing.externalized-checkpoint-retention: RETAIN_ON_CANCELLATION
    execution.checkpointing.min-pause: 5000  # 5 seconds minimum pause between checkpoints
    
    # S3 Configuration - Force IRSA credential provider (matches reference config)
    fs.s3a.aws.credentials.provider: com.amazonaws.auth.WebIdentityTokenCredentialsProvider
    s3.path.style.access: "false"
    
    # Logging
    taskmanager.log.path: /opt/flink/log
    jobmanager.log.path: /opt/flink/log

